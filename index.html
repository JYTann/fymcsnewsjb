<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <!-- åœ¨headæ ‡ç­¾å†…æ·»åŠ è¿™äº› -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ–°å±±å®½æŸ”ä¸­å­¦å¿«è®¯ç»„</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* CSS æ ·å¼éƒ¨åˆ† */
    :root {
      --color-bg: #f8f9fa;
      --color-text: #333333;
      --color-primary: #1a5276;
      --color-secondary: #2980b9;
      --color-accent: #e74c3c;
      --color-border: #e0e0e0;
      --color-card: #ffffff;
      --color-shadow: rgba(0,0,0,0.1);
      --color-meta: #7f8c8d;
      --color-success: #27ae60;
      --color-warning: #f39c12;
    }

    [data-theme="dark"] {
      --color-bg: #1a1a1a;
      --color-text: #f5f5f5;
      --color-primary: #4a90e2;
      --color-secondary: #5dade2;
      --color-accent: #e74c3c;
      --color-border: #444444;
      --color-card: #2d2d2d;
      --color-shadow: rgba(255,255,255,0.05);
      --color-meta: #aaaaaa;
      --color-success: #2ecc71;
      --color-warning: #f39c12;
    }

    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body { 
      font-family: 'Noto Sans SC', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    header {
      background: var(--color-primary);
      color: white;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
      flex: 1;
    }

    .card {
      background: var(--color-card);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px var(--color-shadow);
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid var(--color-border);
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px var(--color-shadow);
    }

    .clickable {
      cursor: pointer;
    }

    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-family: 'Noto Sans SC', sans-serif;
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-secondary);
    }

    .btn-secondary {
      background: var(--color-secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: var(--color-primary);
    }

    .btn-danger {
      background: var(--color-accent);
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-success {
      background: var(--color-success);
      color: white;
    }

    .btn-success:hover {
      background: #219653;
    }

    .btn-warning {
      background: var(--color-warning);
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-outline {
      background: none;
      border: 2px solid var(--color-primary);
      color: var(--color-primary);
    }

    .btn-outline:hover {
      background: var(--color-primary);
      color: white;
    }

    .theme-toggle {
      position: absolute;
      right: 1rem;
      top: 1rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: all 0.3s ease;
      color: white;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .header-logo {
      height: 60px;
      width: 60px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
      transition: transform 0.3s ease;
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    .header-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      color: rgba(255,255,255,0.8);
    }

    .editor-toolbar {
      background: var(--color-bg);
      padding: 0.8rem;
      border-radius: 8px;
      margin: 1rem 0;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      border: 1px solid var(--color-border);
    }

    #editor {
      min-height: 400px;
      border: 2px solid var(--color-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem 0;
      outline: none;
      background: var(--color-card);
      color: var(--color-text);
      font-size: 1rem;
      line-height: 1.8;
    }

    input[type="text"], textarea, select {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 2px solid var(--color-border);
      border-radius: 8px;
      margin: 0.5rem 0;
      font-size: 1rem;
      transition: border-color 0.2s;
      background: var(--color-card);
      color: var(--color-text);
      font-family: 'Noto Sans SC', sans-serif;
    }

    input[type="text"]:focus, 
    textarea:focus,
    #editor:focus,
    select:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(26, 82, 118, 0.2);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--color-card);
      color: var(--color-text);
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .modal-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--color-primary);
      font-weight: 600;
    }

    .news-meta {
      color: var(--color-meta);
      font-size: 0.9rem;
      margin: 0.5rem 0 1.5rem;
      display: flex;
      gap: 1.5rem;
    }

    .action-buttons {
      display: flex;
      gap: 0.8rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    .news-content img {
      max-width: 100%;
      height: auto;
      margin: 1.5rem 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--color-shadow);
    }

    .full-width {
      width: 100%;
      margin: 0.8rem 0;
    }

    .hidden {
      display: none !important;
    }

    .news-image {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px var(--color-shadow);
    }

    .news-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--color-primary);
      line-height: 1.3;
    }

    .news-excerpt {
      color: var(--color-meta);
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .news-card {
      transition: all 0.3s ease;
    }

    .news-card:hover {
      transform: translateY(-5px);
    }

    .news-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .tool-btn {
      padding: 0.5rem 0.8rem;
      border: 1px solid var(--color-border);
      background: var(--color-card);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
      height: 36px;
    }

    .tool-btn:hover {
      background: var(--color-bg);
    }

    .tool-btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .font-selector, .size-selector {
      padding: 0.5rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-card);
      color: var(--color-text);
      height: 36px;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--color-border);
    }

    .editor-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--color-primary);
    }

    .share-buttons {
      display: flex;
      gap: 0.8rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    .share-btn {
      padding: 0.6rem 1rem;
      border-radius: 6px;
      color: white;
      text-decoration: none;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .share-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .facebook {
      background: #3b5998;
    }

    .twitter {
      background: #1da1f2;
    }

    .whatsapp {
      background: #25d366;
    }

    .link {
      background: var(--color-secondary);
    }

    .back-btn {
      margin-bottom: 1.5rem;
    }

    .category-tag {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      background: var(--color-secondary);
      color: white;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .category-selector {
      margin-bottom: 1rem;
    }

    .status-badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-left: 0.5rem;
    }

    .published {
      background: var(--color-success);
      color: white;
    }

    .draft {
      background: var(--color-warning);
      color: white;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }

    .loading-spinner {
      border: 4px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top: 4px solid var(--color-primary);
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .header-content {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
      
      .header-logo {
        height: 50px;
        width: 50px;
      }
      
      .theme-toggle {
        position: static;
        margin-left: auto;
      }

      .news-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons, .share-buttons {
        gap: 0.5rem;
      }

      .news-title {
        font-size: 1.5rem;
      }

      #editor {
        min-height: 300px;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- HTML ç»“æ„éƒ¨åˆ† -->
  <header>
    <button class="theme-toggle">
      <i class="fas fa-moon"></i>
    </button>
    <div class="header-content">
      <div class="logo-container">
        <img src="https://i.postimg.cc/cLL4VqKS/1530689364-computer-society-removebg-preview.png" 
             alt="ç”µè„‘åä¼šLogo"
             class="header-logo">
        <div>
          <h1 class="header-title">æ–°å±±å®½æŸ”ä¸­å­¦ç”µè„‘åä¼šå¿«è®¯ç»„ FYMCSJB NEWS GROUP</h1>
          <p class="header-subtitle">åŠæ—¶ä¼ é€’å›½å†…å¤–ç§‘æŠ€èµ„è®¯ï¼ŒæœåŠ¡å¹¿å¤§å¸ˆç”Ÿ</p>
        </div>
      </div>
      <button id="logoutBtn" class="btn btn-outline hidden">ç™»å‡º</button>
    </div>
  </header>

  <div class="container">
    <!-- ç™»å½•ç•Œé¢ -->
    <section id="login">
      <div class="card">
        <h2 style="text-align: center; margin-bottom: 2rem;">ç³»ç»Ÿç™»å½•</h2>
        <div class="role-select" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
          <button class="btn btn-primary" id="adminLoginBtn">
            <i class="fas fa-user-shield"></i>
            ç®¡ç†å‘˜ç™»å½•
          </button>
          <button class="btn btn-success" id="guestLoginBtn">
            <i class="fas fa-user"></i>
            è®¿å®¢æµè§ˆ
          </button>
        </div>
      </div>
    </section>

    <!-- åå°ç®¡ç† -->
    <section id="dashboard" class="hidden">
      <div class="card">
        <div class="editor-header">
          <h2 class="editor-title"><i class="fas fa-newspaper"></i> å‘å¸ƒæ–°é—»</h2>
        </div>
        
        <input id="titleInput" type="text" placeholder="è¯·è¾“å…¥æ–°é—»æ ‡é¢˜" class="full-width" />
        
        <div class="category-selector">
          <select id="categorySelect" class="full-width">
            <option value="ç§‘æŠ€æ–°é—»">ç§‘æŠ€æ–°é—»</option>
            <option value="æ´»åŠ¨é¢„å‘Š">æ´»åŠ¨é¢„å‘Š</option>
            <option value="å­¦æœ¯åŠ¨æ€">å­¦æœ¯åŠ¨æ€</option>
            <option value="ä½“è‚²èµ›äº‹">ä½“è‚²èµ›äº‹</option>
            <option value="ç¤¾å›¢æ´»åŠ¨">ç¤¾å›¢æ´»åŠ¨</option>
          </select>
        </div>
        
        <div class="editor-toolbar">
          <select class="font-selector">
            <option value="'Noto Sans SC', sans-serif">é»˜è®¤å­—ä½“</option>
            <option value="'SimSun', serif">å®‹ä½“</option>
            <option value="'Microsoft YaHei', sans-serif">å¾®è½¯é›…é»‘</option>
            <option value="'KaiTi', serif">æ¥·ä½“</option>
          </select>
          
          <select class="size-selector">
            <option value="1">å°</option>
            <option value="3" selected>ä¸­</option>
            <option value="5">å¤§</option>
            <option value="7">ç‰¹å¤§</option>
          </select>
          
          <button class="tool-btn" title="åŠ ç²—">
            <i class="fas fa-bold"></i>
          </button>
          <button class="tool-btn" title="æ–œä½“">
            <i class="fas fa-italic"></i>
          </button>
          <button class="tool-btn" title="ä¸‹åˆ’çº¿">
            <i class="fas fa-underline"></i>
          </button>
          
          <button class="tool-btn" title="æ— åºåˆ—è¡¨">
            <i class="fas fa-list-ul"></i>
          </button>
          <button class="tool-btn" title="æœ‰åºåˆ—è¡¨">
            <i class="fas fa-list-ol"></i>
          </button>
          
          <button class="tool-btn" title="å·¦å¯¹é½">
            <i class="fas fa-align-left"></i>
          </button>
          <button class="tool-btn" title="å±…ä¸­å¯¹é½">
            <i class="fas fa-align-center"></i>
          </button>
          <button class="tool-btn" title="å³å¯¹é½">
            <i class="fas fa-align-right"></i>
          </button>
          
          <button class="tool-btn" title="æ’å…¥å›¾ç‰‡">
            <i class="fas fa-image"></i>
          </button>
          <input type="file" id="imageUpload" accept="image/*" style="display: none;">
          
          <button class="tool-btn" title="æ’å…¥é“¾æ¥">
            <i class="fas fa-link"></i>
          </button>
          <button class="tool-btn" title="ç§»é™¤é“¾æ¥">
            <i class="fas fa-unlink"></i>
          </button>
        </div>
        
        <div id="editor" contenteditable="true"></div>
        
        <div class="action-buttons">
          <button class="btn btn-success" id="draftBtn">
            <i class="fas fa-save"></i>
            ä¿å­˜è‰ç¨¿
          </button>
          <button class="btn btn-primary" id="publishBtn">
            <i class="fas fa-paper-plane"></i>
            å‘å¸ƒæ–°é—»
          </button>
        </div>
      </div>

      <div class="card">
        <div class="editor-header">
          <h2 class="editor-title"><i class="fas fa-tasks"></i> æ–°é—»ç®¡ç†</h2>
          <div>
            <select id="newsFilter">
              <option value="all">å…¨éƒ¨æ–°é—»</option>
              <option value="published">å·²å‘å¸ƒ</option>
              <option value="drafts">è‰ç¨¿</option>
            </select>
          </div>
        </div>
        <div id="newsListAdmin">
          <div class="loading">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- æ–°é—»åˆ—è¡¨ -->
    <section id="newsList" class="hidden">
      <div class="card">
        <div class="editor-header">
          <h2 class="editor-title"><i class="fas fa-bell"></i> æœ€æ–°æ¶ˆæ¯</h2>
          <div>
            <select id="categoryFilter">
              <option value="all">å…¨éƒ¨ç±»åˆ«</option>
              <option value="ç§‘æŠ€æ–°é—»">ç§‘æŠ€æ–°é—»</option>
              <option value="æ´»åŠ¨é¢„å‘Š">æ´»åŠ¨é¢„å‘Š</option>
              <option value="å­¦æœ¯åŠ¨æ€">å­¦æœ¯åŠ¨æ€</option>
              <option value="ä½“è‚²èµ›äº‹">ä½“è‚²èµ›äº‹</option>
              <option value="ç¤¾å›¢æ´»åŠ¨">ç¤¾å›¢æ´»åŠ¨</option>
            </select>
          </div>
        </div>
        <div class="news-grid" id="newsItems">
          <div class="loading">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- æ–°é—»è¯¦æƒ… -->
    <section id="newsDetail" class="hidden">
      <div class="card">
        <button class="btn btn-outline back-btn" id="backToListBtn">
          <i class="fas fa-arrow-left"></i>
          è¿”å›åˆ—è¡¨
        </button>
        <div id="detailContent" style="margin-top: 1.5rem;"></div>
      </div>
    </section>
  </div>

  <!-- ç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡† -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title"><i class="fas fa-user-shield"></i> ç®¡ç†å‘˜éªŒè¯</h3>
      <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " class="full-width" />
      <div class="action-buttons" style="margin-top: 1.5rem;">
        <button class="btn btn-primary" id="confirmLoginBtn">
          <i class="fas fa-sign-in-alt"></i>
          ç¡®è®¤ç™»å½•
        </button>
        <button class="btn btn-danger" id="cancelLoginBtn">
          <i class="fas fa-times"></i>
          å–æ¶ˆ
        </button>
      </div>
    </div>
  </div>

  <script>
    // JavaScript ä»£ç éƒ¨åˆ†

    const firebaseConfig = {
      apiKey: "AIzaSyBRnuwJhNE8zgWSZ2USJT5pCh138ik4G54",
      authDomain: "fymcsnewsjb.firebaseapp.com",
      projectId: "fymcsnewsjb",
      storageBucket: "fymcsnewsjb.firebasestorage.app",
      messagingSenderId: "843017779813",
      appId: "1:843017779813:web:180674b052abbf9b36248c",
      measurementId: "G-M9L0H4E2FR"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
let editingId = null;
let role = "";

    // é¡µé¢å…ƒç´ å¼•ç”¨
    const editor = document.getElementById("editor");
    const titleInput = document.getElementById("titleInput");
    const categorySelect = document.getElementById("categorySelect");
    const logoutBtn = document.getElementById("logoutBtn");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const guestLoginBtn = document.getElementById("guestLoginBtn");
    const draftBtn = document.getElementById("draftBtn");
    const publishBtn = document.getElementById("publishBtn");
    const newsFilter = document.getElementById("newsFilter");
    const categoryFilter = document.getElementById("categoryFilter");
    const backToListBtn = document.getElementById("backToListBtn");
    const confirmLoginBtn = document.getElementById("confirmLoginBtn");
    const cancelLoginBtn = document.getElementById("cancelLoginBtn");
    const adminModal = document.getElementById("adminModal");
    const adminPassword = document.getElementById("adminPassword");
    const themeToggle = document.querySelector(".theme-toggle");

    // åˆå§‹åŒ–æ•°æ®åº“
    // è·å–æ‰€æœ‰æ–°é—»ï¼ˆæŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼‰
    async function getAllNews() {
      try {
        const snapshot = await db.collection("news").orderBy("time", "desc").get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error("è·å–æ–°é—»å¤±è´¥:", error);
        alert("åŠ è½½æ–°é—»å¤±è´¥: " + error.message);
        return [];
      }
    }
    
    // æ·»åŠ æ–°æ–°é—»
    async function addNews(newsItem) {
      await db.collection("news").add(newsItem);
    }
    
    // æ›´æ–°æ–°é—»
    async function updateNews(newsItem) {
      await db.collection("news").doc(newsItem.id).update(newsItem);
    }
    
    // åˆ é™¤æ–°é—»
    async function deleteNewsById(id) {
      await db.collection("news").doc(id).delete();
    }
    
    // è·å–å•æ¡æ–°é—»
    async function getNewsById(id) {
      const doc = await db.collection("news").doc(id).get();
      return doc.exists ? { id: doc.id, ...doc.data() } : null;
    }
    
    // æŒ‰ç±»åˆ«è·å–æ–°é—»
    async function getNewsByCategory(category) {
      let query = db.collection("news").orderBy("time", "desc");
      if (category !== "all") {
        query = query.where("category", "==", category);
      }
      const snapshot = await query.get();
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }
    
    // æŒ‰çŠ¶æ€è·å–æ–°é—»ï¼ˆå‘å¸ƒ/è‰ç¨¿ï¼‰
    async function getNewsByStatus(status) {
      let query = db.collection("news").orderBy("time", "desc");
      if (status !== "all") {
        query = query.where("status", "==", status);
      }
      const snapshot = await query.get();
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    // ä¸»é¢˜åˆ‡æ¢
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      // æ›´æ–°å›¾æ ‡
      const themeIcon = document.querySelector('.theme-toggle i');
      themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }

    // æ˜¾ç¤ºç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡†
    function showAdminLogin() {
      adminModal.style.display = "flex";
      adminPassword.focus();
    }

    // éšè—ç®¡ç†å‘˜ç™»å½•æ¨¡æ€æ¡†
    function hideAdminModal() {
      adminModal.style.display = "none";
      adminPassword.value = "";
    }

    // ç®¡ç†å‘˜ç™»å½•éªŒè¯
    function verifyAdmin() {
      const password = adminPassword.value;
      if (password === "Microcomputersociety") {
        loginAs("admin");
        hideAdminModal();
      } else {
        alert("âš ï¸ å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥ï¼");
        adminPassword.value = "";
      }
    }

    // ç”¨æˆ·ç™»å½•ç³»ç»Ÿ
    async function loginAs(selectedRole) {
      role = selectedRole;
      document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
      logoutBtn.classList.remove('hidden');

      if (role === 'admin') {
        document.getElementById('dashboard').classList.remove('hidden');
        await loadNewsForAdmin();
      } else {
        document.getElementById('newsList').classList.remove('hidden');
        await loadNewsList();
      }
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      role = "";
      document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
      document.getElementById('login').classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      titleInput.value = "";
      editor.innerHTML = "";
      editingId = null;
    }

    // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åŠŸèƒ½
    function execCmd(cmd, value = null) {
      document.execCommand(cmd, false, value);
      editor.focus();
    }

    // æ–°é—»å‘å¸ƒ/æ›´æ–°åŠŸèƒ½
    async function publishNews() {
      const title = titleInput.value.trim();
      const content = editor.innerHTML.trim();
      const category = categorySelect.value;
      
      if (!title) return alert("âš ï¸ è¯·è¾“å…¥æ–°é—»æ ‡é¢˜ï¼");
      if (!content || content === "<p><br></p>") return alert("âš ï¸ æ–°é—»å†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
      
      try {
        const newsItem = {
          title,
          content,
          category,
          editor: "ç®¡ç†å‘˜",
          time: new Date().toISOString(),  // æ”¹ä¸ºISOæ ¼å¼æ—¶é—´
          status: 'published'
        };
        
        if (editingId) {
          // æ›´æ–°ç°æœ‰æ–°é—»
          await db.collection("news").doc(editingId).update(newsItem);
          editingId = null;
          publishBtn.innerHTML = '<i class="fas fa-paper-plane"></i> å‘å¸ƒæ–°é—»';
        } else {
          // æ–°å¢æ–°é—»
          await db.collection("news").add(newsItem);
        }
        
        // é‡ç½®è¡¨å•
        titleInput.value = "";
        editor.innerHTML = "";
        categorySelect.value = "ç§‘æŠ€æ–°é—»";
        
        // é‡æ–°åŠ è½½æ–°é—»åˆ—è¡¨
        await loadNewsForAdmin();
        alert(editingId ? "âœ… æ–°é—»æ›´æ–°æˆåŠŸï¼" : "âœ… æ–°é—»å‘å¸ƒæˆåŠŸï¼");
      } catch (error) {
        console.error("å‘å¸ƒæ–°é—»å¤±è´¥:", error);
        alert("âŒ å‘å¸ƒæ–°é—»å¤±è´¥ï¼Œè¯·é‡è¯•ï¼é”™è¯¯ä¿¡æ¯: " + error.message);
      }
    }

    // ä¿å­˜ä¸ºè‰ç¨¿
    async function saveAsDraft() {
      const title = titleInput.value.trim();
      const content = editor.innerHTML.trim();
      const category = categorySelect.value;
      
      if (!title && !content) return alert("âš ï¸ è¯·è¾“å…¥æ ‡é¢˜æˆ–å†…å®¹ï¼");

      try {
        const newsItem = {
          title: title || "æ— æ ‡é¢˜",
          content: content || "<p>æ— å†…å®¹</p>",
          category,
          editor: "ç®¡ç†å‘˜",
          time: new Date().toISOString(),  // æ”¹ä¸ºISOæ ¼å¼æ—¶é—´
          status: 'draft'
        };
        
        if (editingId) {
          // æ›´æ–°ç°æœ‰è‰ç¨¿
          await db.collection("news").doc(editingId).update(newsItem);
          alert("ğŸ“ è‰ç¨¿æ›´æ–°æˆåŠŸï¼");
        } else {
          // æ–°å¢è‰ç¨¿
          await db.collection("news").add(newsItem);
          alert("ğŸ“ è‰ç¨¿ä¿å­˜æˆåŠŸï¼");
        }
        
        // é‡æ–°åŠ è½½æ–°é—»åˆ—è¡¨
        await loadNewsForAdmin();
        
      } catch (error) {
        console.error("ä¿å­˜è‰ç¨¿å¤±è´¥:", error);
        alert("âŒ ä¿å­˜è‰ç¨¿å¤±è´¥ï¼Œè¯·é‡è¯•ï¼é”™è¯¯ä¿¡æ¯: " + error.message);
      }
    }

    // æ–°é—»åˆ é™¤åŠŸèƒ½
    async function deleteNews(id) {
      if (!confirm("âš ï¸ ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™æ¡æ–°é—»å—ï¼Ÿ")) return;
      
      try {
        await deleteNewsById(id);
        await loadNewsForAdmin();
        alert("ğŸ—‘ï¸ æ–°é—»å·²åˆ é™¤ï¼");
      } catch (error) {
        console.error("åˆ é™¤æ–°é—»å¤±è´¥:", error);
        alert("âŒ åˆ é™¤æ–°é—»å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
      }
    }

    // æ–°é—»ç¼–è¾‘åŠŸèƒ½
    async function editNews(id) {
      try {
        const newsItem = await getNewsById(id);
        titleInput.value = newsItem.title;
        editor.innerHTML = newsItem.content;
        categorySelect.value = newsItem.category || "ç§‘æŠ€æ–°é—»";
        editingId = id;
        
        // æ›´æ–°æŒ‰é’®æ–‡æœ¬
        publishBtn.innerHTML = 
          newsItem.status === 'draft' ? 
          '<i class="fas fa-paper-plane"></i> å‘å¸ƒæ–°é—»' : 
          '<i class="fas fa-sync-alt"></i> æ›´æ–°æ–°é—»';
        
        window.scrollTo({ top: 0, behavior: "smooth" });
      } catch (error) {
        console.error("åŠ è½½æ–°é—»å¤±è´¥:", error);
        alert("âŒ åŠ è½½æ–°é—»å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
      }
    }

    // åŠ è½½ç®¡ç†å‘˜ç•Œé¢
    async function loadNewsForAdmin() {
      try {
        const filter = newsFilter.value;
        let news;
        
        if (filter === 'drafts') {
          news = await getNewsByStatus('draft');
        } else if (filter === 'published') {
          news = await getNewsByStatus('published');
        } else {
          news = await getAllNews();
        }
        
        // æŒ‰æ—¶é—´é™åºæ’åº
        news.sort((a, b) => new Date(b.time) - new Date(a.time));
        
        const container = document.getElementById("newsListAdmin");
        
        if (news.length === 0) {
          container.innerHTML = `
            <div class="card">
              <p style="text-align: center; color: var(--color-meta);">
                ${filter === 'drafts' ? 'æš‚æ— è‰ç¨¿' : filter === 'published' ? 'æš‚æ— å·²å‘å¸ƒæ–°é—»' : 'æš‚æ— æ–°é—»'}
              </p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = news.map(n => `
          <div class="card">
            <h3>${n.title} 
              <span class="status-badge ${n.status === 'published' ? 'published' : 'draft'}">
                ${n.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'}
              </span>
            </h3>
            <div class="news-meta">
              <span><i class="fas fa-calendar-alt"></i> ${n.time}</span>
              <span><i class="fas fa-user-edit"></i> ${n.editor}</span>
              <span class="category-tag">${n.category}</span>
            </div>
            <div class="action-buttons">
              <button class="btn btn-primary edit-news" data-id="${n.id}">
                <i class="fas fa-edit"></i>
                ç¼–è¾‘
              </button>
              <button class="btn btn-danger delete-news" data-id="${n.id}">
                <i class="fas fa-trash"></i>
                åˆ é™¤
              </button>
              ${n.status === 'draft' ? `
                <button class="btn btn-success edit-news" data-id="${n.id}">
                  <i class="fas fa-paper-plane"></i>
                  å‘å¸ƒ
                </button>
              ` : ''}
            </div>
          </div>
        `).join("");
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.querySelectorAll('.edit-news').forEach(btn => {
          btn.addEventListener('click', () => {
            editNews(btn.dataset.id);
          });
        });
        
        document.querySelectorAll('.delete-news').forEach(btn => {
          btn.addEventListener('click', () => {
            deleteNews(btn.dataset.id);
          });
        });
      } catch (error) {
        console.error("åŠ è½½æ–°é—»åˆ—è¡¨å¤±è´¥:", error);
        document.getElementById("newsListAdmin").innerHTML = `
          <div class="card">
            <p style="text-align: center; color: var(--color-accent);">
              <i class="fas fa-exclamation-triangle"></i> åŠ è½½æ–°é—»åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•
            </p>
          </div>
        `;
      }
    }

    // åŠ è½½æ–°é—»åˆ—è¡¨
    async function loadNewsList() {
      try {
        const category = categoryFilter.value;
        const news = await getNewsByCategory(category);
        
        // æŒ‰æ—¶é—´é™åºæ’åº
        news.sort((a, b) => new Date(b.time) - new Date(a.time));
        
        const container = document.getElementById("newsItems");
        
        if (news.length === 0) {
          container.innerHTML = `
            <div class="card">
              <p style="text-align: center; color: var(--color-meta);">
                æš‚æ— æ–°é—»
              </p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = news.map(n => `
          <div class="card news-card clickable" data-id="${n.id}">
            <div class="news-meta">
              <span><i class="fas fa-calendar-alt"></i> ${n.time}</span>
              <span class="category-tag">${n.category}</span>
            </div>
            <h3>${n.title}</h3>
            <div class="news-excerpt">
              ${n.content.substring(0, 100)}...
            </div>
          </div>
        `).join("");
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.news-card').forEach(card => {
          card.addEventListener('click', () => {
            showNewsDetail(card.dataset.id);
          });
        });
      } catch (error) {
        console.error("åŠ è½½æ–°é—»åˆ—è¡¨å¤±è´¥:", error);
        document.getElementById("newsItems").innerHTML = `
          <div class="card">
            <p style="text-align: center; color: var(--color-accent);">
              <i class="fas fa-exclamation-triangle"></i> åŠ è½½æ–°é—»åˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•
            </p>
          </div>
        `;
      }
    }

    // æ˜¾ç¤ºæ–°é—»è¯¦æƒ…
    async function showNewsDetail(id) {
      try {
        const newsItem = await getNewsById(id);
        const detailContent = document.getElementById('detailContent');
        
        detailContent.innerHTML = `
          <h1 class="news-title">${newsItem.title}</h1>
          <div class="news-meta">
            <span><i class="fas fa-calendar-alt"></i> ${newsItem.time}</span>
            <span><i class="fas fa-user-edit"></i> ${newsItem.editor}</span>
            <span class="category-tag">${newsItem.category}</span>
          </div>
          <div class="news-content">
            ${newsItem.content}
          </div>
        `;
        
        // æ˜¾ç¤ºè¯¦æƒ…éƒ¨åˆ†
        document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
        document.getElementById('newsDetail').classList.remove('hidden');
      } catch (error) {
        console.error('åŠ è½½æ–°é—»è¯¦æƒ…å¤±è´¥:', error);
        alert('åŠ è½½æ–°é—»è¯¦æƒ…å¤±è´¥ï¼');
      }
    }

    // è¿”å›æ–°é—»åˆ—è¡¨
    function showNewsList() {
      document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
      document.getElementById('newsList').classList.remove('hidden');
    }

    // åˆå§‹åŒ–é¡µé¢
    async function initialize() {
      try {
        
        // åˆå§‹åŒ–ä¸»é¢˜
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        const themeIcon = document.querySelector('.theme-toggle i');
        themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';

        // å¤„ç†URLå‚æ•°
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        
        if (id) {
          // ç›´æ¥è®¿é—®è¯¦æƒ…é¡µ
          document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
          document.getElementById('newsDetail').classList.remove('hidden');
          await showNewsDetail(id);
          role = 'guest';
          logoutBtn.classList.remove('hidden');
        } else {
          // æ˜¾ç¤ºç™»å½•ç•Œé¢
          document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
          document.getElementById('login').classList.remove('hidden');
          logoutBtn.classList.add('hidden');
        }

        // è®¾ç½®ç¼–è¾‘å™¨ä¿æŠ¤
        editor.addEventListener("blur", () => {
          if (editor.innerHTML.trim() === "") {
            editor.innerHTML = "<p><br></p>";
          }
        });
        
      } catch (error) {
        console.error("åˆå§‹åŒ–å¤±è´¥:", error);
        document.getElementById('login').innerHTML = `
          <div class="card">
            <h2 style="text-align: center; margin-bottom: 1rem;">ç³»ç»Ÿé”™è¯¯</h2>
            <p style="text-align: center; color: var(--color-accent);">
              <i class="fas fa-exclamation-triangle"></i> ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•
            </p>
            <button class="btn btn-primary full-width" onclick="location.reload()">
              <i class="fas fa-sync-alt"></i> åˆ·æ–°é¡µé¢
            </button>
          </div>
        `;
      }
    }

    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    function bindEventListeners() {
      // ä¸»é¢˜åˆ‡æ¢
      themeToggle.addEventListener('click', toggleTheme);
      
      // ç™»å½•æŒ‰é’®
      adminLoginBtn.addEventListener('click', showAdminLogin);
      guestLoginBtn.addEventListener('click', () => loginAs('guest'));
      
      // ç™»å‡ºæŒ‰é’®
      logoutBtn.addEventListener('click', logout);
      
      // æ¨¡æ€æ¡†æŒ‰é’®
      confirmLoginBtn.addEventListener('click', verifyAdmin);
      cancelLoginBtn.addEventListener('click', hideAdminModal);
      
      // æ–°é—»ç®¡ç†æŒ‰é’®
      newsFilter.addEventListener('change', () => loadNewsForAdmin());
      categoryFilter.addEventListener('change', () => loadNewsList());
      
      // ç¼–è¾‘å™¨æŒ‰é’®
      draftBtn.addEventListener('click', saveAsDraft);
      publishBtn.addEventListener('click', publishNews);
      
      // è¿”å›æŒ‰é’®
      backToListBtn.addEventListener('click', showNewsList);
      
      // å¯Œæ–‡æœ¬å·¥å…·æŒ‰é’®
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const title = btn.getAttribute('title');
          if (title === 'åŠ ç²—') execCmd('bold');
          else if (title === 'æ–œä½“') execCmd('italic');
          else if (title === 'ä¸‹åˆ’çº¿') execCmd('underline');
          else if (title === 'æ— åºåˆ—è¡¨') execCmd('insertUnorderedList');
          else if (title === 'æœ‰åºåˆ—è¡¨') execCmd('insertOrderedList');
          else if (title === 'å·¦å¯¹é½') execCmd('justifyLeft');
          else if (title === 'å±…ä¸­å¯¹é½') execCmd('justifyCenter');
          else if (title === 'å³å¯¹é½') execCmd('justifyRight');
          else if (title === 'æ’å…¥å›¾ç‰‡') insertImage();
          else if (title === 'æ’å…¥é“¾æ¥') execCmd('createLink');
          else if (title === 'ç§»é™¤é“¾æ¥') execCmd('unlink');
        });
      });
      
      // å­—ä½“é€‰æ‹©
      document.querySelector('.font-selector').addEventListener('change', function() {
        execCmd('fontName', false, this.value);
      });
      
      // å­—å·é€‰æ‹©
      document.querySelector('.size-selector').addEventListener('change', function() {
        execCmd('fontSize', false, this.value);
      });
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', async () => {
      await initialize();
      bindEventListeners();
    });
  </script>
</body>
</html>
