<!DOCTYPE html>
<html lang="zh" data-theme="light">
<head>
  <!-- 在head标签内添加这些 -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>新山宽柔中学快讯组</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* CSS 样式部分 */
    footer {
      text-align: center;
      padding: 1.5rem;
      background: var(--color-primary);
      color: white;
      margin-top: auto;
      font-size: 0.9rem;
    }
    
    footer a {
      color: white;
      text-decoration: none;
      transition: opacity 0.2s;
    }
    
    footer a:hover {
      opacity: 0.8;
      text-decoration: underline;
    }
    
    .pinned {
      background: var(--color-accent);
      color: white;
    }
    
    .pinned-news {
      border: 2px solid var(--color-accent);
      position: relative;
      overflow: hidden;
    }

    .pinned-news::before {
      content: "置顶";
      position: absolute;
      top: 10px;
      right: -25px;
      background: var(--color-accent);
      color: white;
      padding: 2px 30px;
      transform: rotate(45deg);
      font-size: 12px;
      font-weight: bold;
    }

    :root {
      --color-bg: #f8f9fa;
      --color-text: #333333;
      --color-primary: #1a5276;
      --color-secondary: #2980b9;
      --color-accent: #e74c3c;
      --color-border: #e0e0e0;
      --color-card: #ffffff;
      --color-shadow: rgba(0,0,0,0.1);
      --color-meta: #7f8c8d;
      --color-success: #27ae60;
      --color-warning: #f39c12;
    }

    [data-theme="dark"] {
      --color-bg: #1a1a1a;
      --color-text: #f5f5f5;
      --color-primary: #4a90e2;
      --color-secondary: #5dade2;
      --color-accent: #e74c3c;
      --color-border: #444444;
      --color-card: #2d2d2d;
      --color-shadow: rgba(255,255,255,0.05);
      --color-meta: #aaaaaa;
      --color-success: #2ecc71;
      --color-warning: #f39c12;
    }

    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body { 
      font-family: 'Noto Sans SC', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    header {
      background: var(--color-primary);
      color: white;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
      flex: 1;
    }

    .card {
      background: var(--color-card);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 6px 15px var(--color-shadow);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      border: 1px solid var(--color-border);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 20px var(--color-shadow);
    }

    header {
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    }

    .clickable {
      cursor: pointer;
    }

    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-family: 'Noto Sans SC', sans-serif;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-secondary);
    }

    .btn-secondary {
      background: var(--color-secondary);
      color: white;
    }

    .btn-secondary:hover {
      background: var(--color-primary);
    }

    .btn-danger {
      background: var(--color-accent);
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-success {
      background: var(--color-success);
      color: white;
    }

    .btn-success:hover {
      background: #219653;
    }

    .btn-warning {
      background: var(--color-warning);
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    .btn-outline {
      background: none;
      border: 2px solid var(--color-primary);
      color: var(--color-primary);
    }

    .btn-outline:hover {
      background: var(--color-primary);
      color: white;
    }

    .theme-toggle {
      position: absolute;
      right: 1rem;
      top: 1rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: all 0.3s ease;
      color: white;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .header-logo {
      height: 60px;
      width: 60px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
      transition: transform 0.3s ease;
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    .header-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
      color: rgba(255,255,255,0.8);
    }

    .editor-toolbar {
      background: var(--color-bg);
      padding: 0.8rem;
      border-radius: 8px;
      margin: 1rem 0;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      border: 1px solid var(--color-border);
    }

    #editor {
      min-height: 400px;
      border: 2px solid var(--color-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin: 1rem 0;
      outline: none;
      background: var(--color-card);
      color: var(--color-text);
      font-size: 1rem;
      line-height: 1.8;
    }

    input[type="text"], textarea, select {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 2px solid var(--color-border);
      border-radius: 8px;
      margin: 0.5rem 0;
      font-size: 1rem;
      transition: border-color 0.2s;
      background: var(--color-card);
      color: var(--color-text);
      font-family: 'Noto Sans SC', sans-serif;
    }

    input[type="text"]:focus, 
    textarea:focus,
    #editor:focus,
    select:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(26, 82, 118, 0.2);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--color-card);
      color: var(--color-text);
      padding: 2rem;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .modal-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--color-primary);
      font-weight: 600;
    }

    .news-meta {
      color: var(--color-meta);
      font-size: 0.9rem;
      margin: 0.5rem 0 1.5rem;
      display: flex;
      gap: 1.5rem;
    }

    .action-buttons {
      display: flex;
      gap: 0.8rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    .news-content img {
      max-width: 100%;
      height: auto;
      margin: 1.5rem 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--color-shadow);
    }

    .full-width {
      width: 100%;
      margin: 0.8rem 0;
    }

    .hidden {
      display: none !important;
    }

    .news-image {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px var(--color-shadow);
    }

    .news-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--color-primary);
      line-height: 1.3;
    }

    .news-excerpt {
      color: var(--color-meta);
      margin-bottom: 1rem;
      font-size: 1.1rem;
      flex-grow: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }

    .news-card {
      min-height: 200px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }

    .news-card:hover {
      transform: translateY(-5px);
    }

    .news-card h3 {
      transition: color 0.2s;
    }

    .news-card:hover h3 {
      color: var(--color-primary);
    }

    .news-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .tool-btn {
      padding: 0.5rem 0.8rem;
      border: 1px solid var(--color-border);
      background: var(--color-card);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
      height: 36px;
    }

    .tool-btn:hover {
      background: var(--color-bg);
    }

    .tool-btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .font-selector, .size-selector {
      padding: 0.5rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-card);
      color: var(--color-text);
      height: 36px;
    }

    .editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--color-border);
    }

    .editor-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--color-primary);
    }

    .share-buttons {
      display: flex;
      gap: 0.8rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    .share-btn {
      padding: 0.6rem 1rem;
      border-radius: 6px;
      color: white;
      text-decoration: none;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .share-section {
      margin-top: 2rem;
      padding: 1rem;
      background: var(--color-card);
      border-radius: 8px;
      border: 1px solid var(--color-border);
    }

    .share-section h3 {
      margin-bottom: 1rem;
      color: var(--color-primary);
    }

    .share-icons a {
      font-size: 1.2rem;
      opacity: 0.7;
      transition: all 0.2s;
    }

    .share-icons a:hover {
      opacity: 1;
      transform: translateY(-2px);
    }

    .news-footer {
      margin-top: auto;
    }

    .share-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .facebook {
      background: #3b5998;
    }

    .twitter {
      background: #1da1f2;
    }

    .whatsapp {
      background: #25d366;
    }

    .link {
      background: var(--color-secondary);
    }

    .back-btn {
      margin-bottom: 1.5rem;
    }

    .category-tag {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      background: var(--color-secondary);
      color: white;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .category-selector {
      margin-bottom: 1rem;
    }

    .status-badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-left: 0.5rem;
    }

    .published {
      background: var(--color-success);
      color: white;
    }

    .draft {
      background: var(--color-warning);
      color: white;
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }

    .loading-spinner {
      border-width: 5px;
      border-top-color: var(--color-primary);
      border-right-color: var(--color-secondary);
      border-bottom-color: var(--color-accent);
      border-left-color: var(--color-success);
      animation: spin 1.5s linear infinite;
    }

    /* 添加到现有CSS中 */

/* 投稿表单样式 */
.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: var(--color-primary);
}

.contribution-card {
  transition: all 0.3s ease;
}

.contribution-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 15px var(--color-shadow);
}

/* 投稿状态标签 */
.status-badge.warning {
  background: var(--color-warning);
  color: white;
}

/* 响应式调整 */
@media (max-width: 768px) {
  .contribution-card .action-buttons {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .contribution-card .action-buttons button {
    width: 100%;
  }
}

    /* 新增浮动操作按钮 */
    .floating-action-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--color-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 99;
      transition: all 0.3s;
    }

    .floating-action-btn:hover {
      transform: translateY(-3px) scale(1.1);
      background: var(--color-secondary);
    }

    /* 新增分隔线样式 */
    .divider {
      height: 1px;
      background: var(--color-border);
      margin: 1.5rem 0;
      opacity: 0.5;
    }

    /* 新增卡片标题样式 */
    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--color-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* 新增小工具样式 */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); opacity: 0.5; }
      50% { opacity: 1; }
      100% { transform: rotate(360deg); opacity: 0.5; }
    }

    @media (max-width: 768px) {

      .pinned-news::before {
        top: 5px;
        right: -30px;
        font-size: 10px;
      }
      
      .floating-action-btn {
        width: 50px;
        height: 50px;
        bottom: 20px;
        right: 20px;
        font-size: 20px;
      }

      .container {
        padding: 1rem;
      }
      
      .header-content {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
      }
      
      .header-logo {
        height: 50px;
        width: 50px;
      }
      
      .theme-toggle {
        position: static;
        margin-left: auto;
      }

      .news-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons, .share-buttons {
        gap: 0.5rem;
      }

      .news-title {
        font-size: 1.5rem;
      }

      #editor {
        min-height: 300px;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- HTML 结构部分 -->
  <header>
    <button class="theme-toggle">
      <i class="fas fa-moon"></i>
    </button>
    <div class="header-content">
      <div class="logo-container">
        <img src="https://i.postimg.cc/cLL4VqKS/1530689364-computer-society-removebg-preview.png" 
             alt="电脑协会Logo"
             class="header-logo">
        <div>
          <h1 class="header-title">新山宽柔中学电脑协会快讯组 FYMCSJB NEWS GROUP</h1>
          <p class="header-subtitle">及时传递国内外科技资讯，服务广大师生</p>
        </div>
      </div>
      <button id="logoutBtn" class="btn btn-outline hidden">登出</button>
    </div>
  </header>

  <div class="container">
  <!-- 登录界面 -->
  <section id="login">
    <div class="card">
      <h2 style="text-align: center; margin-bottom: 2rem;">系统登录</h2>
      <div class="role-select" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-primary" id="adminLoginBtn">
          <i class="fas fa-user-shield"></i> 管理员登录
        </button>
        <button class="btn btn-success" id="guestLoginBtn">
          <i class="fas fa-user"></i> 访客浏览
        </button>
      </div>
    </div>

    <!-- 三格说明区 -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-top: 1.5rem;">
      <!-- 格子1：管理员说明 -->
      <div class="card" style="padding: 1.5rem; text-align: center;">
        <div style="font-size: 2.5rem; color: var(--color-primary); margin-bottom: 1rem;">
          <i class="fas fa-key"></i>
        </div>
        <h3 style="margin-bottom: 0.5rem;">管理员</h3>
        <ul style="text-align: left; padding-left: 1.5rem; color: var(--color-meta);">
          <li>发布/编辑新闻</li>
          <li>管理置顶内容</li>
          <li>审核系统数据</li>
        </ul>
      </div>

      <!-- 格子2：访客说明 -->
      <div class="card" style="padding: 1.5rem; text-align: center;">
        <div style="font-size: 2.5rem; color: var(--color-success); margin-bottom: 1rem;">
          <i class="fas fa-newspaper"></i>
        </div>
        <h3 style="margin-bottom: 0.5rem;">访客</h3>
        <ul style="text-align: left; padding-left: 1.5rem; color: var(--color-meta);">
          <li>浏览公开新闻</li>
          <li>查看活动预告</li>
          <li>无需登录</li>
        </ul>
      </div>

      <!-- 格子3：技术支持 -->
      <div class="card" style="padding: 1.5rem; text-align: center;">
        <div style="font-size: 2.5rem; color: var(--color-accent); margin-bottom: 1rem;">
          <i class="fas fa-code"></i>
        </div>
        <h3 style="margin-bottom: 0.5rem;">技术信息</h3>
        <ul style="text-align: left; padding-left: 1.5rem; color: var(--color-meta);">
          <li>设计：陈俊源</li>
          <li>技术支持：电脑协会</li>
          <li>联络：tanjunyuanfoonyew@gmail.com</li>
        </ul>
      </div>
    </div>
  </section>
</div>

<!-- 移动端适配 -->
<style>
  @media (max-width: 768px) {
    #login > div[style*="grid-template-columns"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>

  <!-- 添加到现有HTML文件的适当位置 -->
<section id="contributeSection" class="hidden">
  <div class="card">
    <div class="editor-header">
      <h2 class="editor-title"><i class="fas fa-paper-plane"></i> 新闻投稿</h2>
    </div>
    
    <div class="card">
      <h3 class="card-title"><i class="fas fa-info-circle"></i> 投稿须知</h3>
      <ul style="padding-left: 1.5rem; margin-bottom: 1.5rem;">
        <li>投稿内容需真实可靠，不得包含虚假信息</li>
        <li>投稿前请仔细检查内容准确性</li>
        <li>投稿后需经管理员审核才能发布</li>
        <li>请留下您的联系方式以便核实信息</li>
      </ul>
    </div>
    
    <form id="contributeForm">
      <div class="form-group">
        <label for="contributorName">投稿人姓名</label>
        <input type="text" id="contributorName" required class="full-width" placeholder="请输入您的姓名">
      </div>
      
      <div class="form-group">
        <label for="contributorContact">联系方式</label>
        <input type="text" id="contributorContact" required class="full-width" placeholder="电话/微信/邮箱">
      </div>
      
      <div class="form-group">
        <label for="contributeTitle">新闻标题</label>
        <input type="text" id="contributeTitle" required class="full-width" placeholder="请输入新闻标题">
      </div>
      
      <div class="form-group">
        <label for="contributeCategory">新闻类别</label>
        <select id="contributeCategory" class="full-width">
          <option value="科技新闻">科技新闻</option>
          <option value="活动预告">活动预告</option>
          <option value="学术动态">学术动态</option>
          <option value="体育赛事">体育赛事</option>
          <option value="社团活动">社团活动</option>
          <option value="其他">其他</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="contributeContent">新闻内容</label>
        <textarea id="contributeContent" rows="8" required class="full-width" placeholder="请输入新闻内容..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="contributeImages">上传图片(可选)</label>
        <input type="file" id="contributeImages" multiple accept="image/*" class="full-width">
        <small style="color: var(--color-meta);">最多可上传3张图片，每张不超过2MB</small>
      </div>
      
      <div class="action-buttons">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-paper-plane"></i> 提交投稿
        </button>
        <button type="reset" class="btn btn-outline">
          <i class="fas fa-undo"></i> 重置表单
        </button>
      </div>
    </form>
  </div>
</section>

  <!-- 添加到管理员面板 -->
<div class="card" id="contributionManagement">
  <div class="editor-header">
    <h2 class="editor-title"><i class="fas fa-inbox"></i> 投稿管理</h2>
    <div>
      <select id="contributionFilter">
        <option value="pending">待审核</option>
        <option value="approved">已通过</option>
        <option value="rejected">已拒绝</option>
        <option value="all">全部投稿</option>
      </select>
    </div>
  </div>
  
  <div id="contributionList">
    <div class="loading">
      <div class="loading-spinner"></div>
    </div>
  </div>
</div>
  
    <!-- 后台管理 -->
    <section id="dashboard" class="hidden">
      <div class="card">
        <div class="editor-header">
          <h2 class="editor-title"><i class="fas fa-newspaper"></i> 发布新闻</h2>
        </div>
        
        <input id="titleInput" type="text" placeholder="请输入新闻标题" class="full-width" />
        
        <div class="category-selector">
          <select id="categorySelect" class="full-width">
            <option value="科技新闻">科技新闻</option>
            <option value="活动预告">活动预告</option>
            <option value="学术动态">学术动态</option>
            <option value="体育赛事">体育赛事</option>
            <option value="社团活动">社团活动</option>
          </select>
        </div>
        
        <div class="editor-toolbar">
          <select class="font-selector">
            <option value="'Noto Sans SC', sans-serif">默认字体</option>
            <option value="'SimSun', serif">宋体</option>
            <option value="'Microsoft YaHei', sans-serif">微软雅黑</option>
            <option value="'KaiTi', serif">楷体</option>
          </select>
          
          <select class="size-selector">
            <option value="1">小</option>
            <option value="3" selected>中</option>
            <option value="5">大</option>
            <option value="7">特大</option>
          </select>
          
          <button class="tool-btn" title="加粗">
            <i class="fas fa-bold"></i>
          </button>
          <button class="tool-btn" title="斜体">
            <i class="fas fa-italic"></i>
          </button>
          <button class="tool-btn" title="下划线">
            <i class="fas fa-underline"></i>
          </button>
          
          <button class="tool-btn" title="无序列表">
            <i class="fas fa-list-ul"></i>
          </button>
          <button class="tool-btn" title="有序列表">
            <i class="fas fa-list-ol"></i>
          </button>
          
          <button class="tool-btn" title="左对齐">
            <i class="fas fa-align-left"></i>
          </button>
          <button class="tool-btn" title="居中对齐">
            <i class="fas fa-align-center"></i>
          </button>
          <button class="tool-btn" title="右对齐">
            <i class="fas fa-align-right"></i>
          </button>
          
          <button class="tool-btn" title="插入图片">
            <i class="fas fa-image"></i>
          </button>
          <input type="file" id="imageUpload" accept="image/*" style="display: none;">
          
          <button class="tool-btn" title="插入链接">
            <i class="fas fa-link"></i>
          </button>
          <button class="tool-btn" title="移除链接">
            <i class="fas fa-unlink"></i>
          </button>
        </div>
        
        <div id="editor" contenteditable="true"></div>
        
        <div class="action-buttons">
          <button class="btn btn-success" id="draftBtn">
            <i class="fas fa-save"></i>
            保存草稿
          </button>
          <button class="btn btn-primary" id="publishBtn">
            <i class="fas fa-paper-plane"></i>
            发布新闻
          </button>
        </div>
      </div>

      <div class="card">
        <div class="editor-header">
          <h2 class="editor-title"><i class="fas fa-tasks"></i> 新闻管理</h2>
          <div>
            <select id="newsFilter">
              <option value="all">全部新闻</option>
              <option value="published">已发布</option>
              <option value="drafts">草稿</option>
            </select>
          </div>
        </div>
        <div id="newsListAdmin">
          <div class="loading">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 新闻列表 -->
    <section id="newsList" class="hidden">
      <div class="card">
        <div class="editor-header">
          <h2 class="editor-title"><i class="fas fa-bell"></i> 最新消息</h2>
          <div>
            <select id="categoryFilter">
              <option value="all">全部类别</option>
              <option value="科技新闻">科技新闻</option>
              <option value="活动预告">活动预告</option>
              <option value="学术动态">学术动态</option>
              <option value="体育赛事">体育赛事</option>
              <option value="社团活动">社团活动</option>
            </select>
          </div>
        </div>
        <div class="news-grid" id="newsItems">
          <div class="loading">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 新闻详情 -->
    <section id="newsDetail" class="hidden">
      <div class="card">
        <button class="btn btn-outline back-btn" id="backToListBtn">
          <i class="fas fa-arrow-left"></i>
          返回列表
        </button>
        <div id="detailContent" style="margin-top: 1.5rem;"></div>
      </div>
    </section>
  </div>

  <!-- 管理员登录模态框 -->
  <div id="adminModal" class="modal">
    <div class="modal-content">
      <h3 class="modal-title"><i class="fas fa-user-shield"></i> 管理员验证</h3>
      <input type="password" id="adminPassword" placeholder="请输入管理员密码" class="full-width" />
      <div class="action-buttons" style="margin-top: 1.5rem;">
        <button class="btn btn-primary" id="confirmLoginBtn">
          <i class="fas fa-sign-in-alt"></i>
          确认登录
        </button>
        <button class="btn btn-danger" id="cancelLoginBtn">
          <i class="fas fa-times"></i>
          取消
        </button>
      </div>
    </div>
  </div>

  <footer>
  <p>© 2025 新山宽柔中学快讯组 | 设计: <a href="tanjunyuanfoonyew@gmail.com">陈俊源</a></p>
  </footer>

  <script>
    // JavaScript 代码部分

    const firebaseConfig = {
      apiKey: "AIzaSyBRnuwJhNE8zgWSZ2USJT5pCh138ik4G54",
      authDomain: "fymcsnewsjb.firebaseapp.com",
      projectId: "fymcsnewsjb",
      storageBucket: "fymcsnewsjb.firebasestorage.app",
      messagingSenderId: "843017779813",
      appId: "1:843017779813:web:180674b052abbf9b36248c",
      measurementId: "G-M9L0H4E2FR"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
let editingId = null;
let role = "";

    // 页面元素引用
    const editor = document.getElementById("editor");
    const titleInput = document.getElementById("titleInput");
    const categorySelect = document.getElementById("categorySelect");
    const logoutBtn = document.getElementById("logoutBtn");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const guestLoginBtn = document.getElementById("guestLoginBtn");
    const draftBtn = document.getElementById("draftBtn");
    const publishBtn = document.getElementById("publishBtn");
    const newsFilter = document.getElementById("newsFilter");
    const categoryFilter = document.getElementById("categoryFilter");
    const backToListBtn = document.getElementById("backToListBtn");
    const confirmLoginBtn = document.getElementById("confirmLoginBtn");
    const cancelLoginBtn = document.getElementById("cancelLoginBtn");
    const adminModal = document.getElementById("adminModal");
    const adminPassword = document.getElementById("adminPassword");
    const themeToggle = document.querySelector(".theme-toggle");

    // 添加到现有JavaScript中

// 投稿表单提交
document.getElementById('contributeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const contribution = {
    name: document.getElementById('contributorName').value,
    contact: document.getElementById('contributorContact').value,
    title: document.getElementById('contributeTitle').value,
    category: document.getElementById('contributeCategory').value,
    content: document.getElementById('contributeContent').value,
    status: 'pending',
    submittedAt: new Date().toISOString()
  };
  
  try {
    // 处理图片上传
    const imagesInput = document.getElementById('contributeImages');
    if (imagesInput.files.length > 0) {
      const images = [];
      for (let i = 0; i < Math.min(3, imagesInput.files.length); i++) {
        const file = imagesInput.files[i];
        if (file.size > 2 * 1024 * 1024) {
          alert(`图片 ${file.name} 超过2MB限制，将不会被上传`);
          continue;
        }
        
        // 这里需要实现图片上传到Firebase Storage的逻辑
        // images.push(上传后的URL);
      }
      contribution.images = images;
    }
    
    await db.collection('contributions').add(contribution);
    alert('投稿提交成功！感谢您的参与，管理员将会审核您的投稿。');
    document.getElementById('contributeForm').reset();
  } catch (error) {
    console.error('投稿提交失败:', error);
    alert('投稿提交失败，请稍后再试！');
  }
});

// 加载投稿列表(管理员)
async function loadContributions(filter = 'pending') {
  try {
    let query = db.collection('contributions').orderBy('submittedAt', 'desc');
    
    if (filter !== 'all') {
      query = query.where('status', '==', filter);
    }
    
    const snapshot = await query.get();
    const contributions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    const container = document.getElementById('contributionList');
    
    if (contributions.length === 0) {
      container.innerHTML = '<div class="card"><p style="text-align: center; color: var(--color-meta);">暂无投稿</p></div>';
      return;
    }
    
    container.innerHTML = contributions.map(c => `
      <div class="card contribution-card" data-id="${c.id}">
        <div class="news-meta">
          <span><i class="fas fa-user"></i> ${c.name}</span>
          <span><i class="fas fa-phone"></i> ${c.contact}</span>
          <span><i class="fas fa-clock"></i> ${formatDate(c.submittedAt)}</span>
          <span class="category-tag">${c.category}</span>
          <span class="status-badge ${c.status === 'approved' ? 'published' : 
                                   c.status === 'rejected' ? 'draft' : 'warning'}">
            ${c.status === 'approved' ? '已通过' : 
             c.status === 'rejected' ? '已拒绝' : '待审核'}
          </span>
        </div>
        <h3>${c.title}</h3>
        <div class="news-excerpt">
          ${stripHtml(c.content).substring(0, 150)}...
        </div>
        
        ${c.images && c.images.length > 0 ? `
          <div style="display: flex; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap;">
            ${c.images.map(img => `<img src="${img}" style="max-height: 100px; border-radius: 4px;">`).join('')}
          </div>
        ` : ''}
        
        <div class="action-buttons">
          <button class="btn btn-primary view-contribution" data-id="${c.id}">
            <i class="fas fa-eye"></i> 查看详情
          </button>
          ${c.status !== 'approved' ? `
            <button class="btn btn-success approve-contribution" data-id="${c.id}">
              <i class="fas fa-check"></i> 通过
            </button>
          ` : ''}
          ${c.status !== 'rejected' ? `
            <button class="btn btn-danger reject-contribution" data-id="${c.id}">
              <i class="fas fa-times"></i> 拒绝
            </button>
          ` : ''}
        </div>
      </div>
    `).join('');
    
    // 绑定按钮事件
    document.querySelectorAll('.view-contribution').forEach(btn => {
      btn.addEventListener('click', () => viewContribution(btn.dataset.id));
    });
    
    document.querySelectorAll('.approve-contribution').forEach(btn => {
      btn.addEventListener('click', () => processContribution(btn.dataset.id, 'approved'));
    });
    
    document.querySelectorAll('.reject-contribution').forEach(btn => {
      btn.addEventListener('click', () => processContribution(btn.dataset.id, 'rejected'));
    });
    
  } catch (error) {
    console.error('加载投稿失败:', error);
    document.getElementById('contributionList').innerHTML = `
      <div class="card">
        <p style="text-align: center; color: var(--color-accent);">
          <i class="fas fa-exclamation-triangle"></i> 加载投稿失败
        </p>
      </div>
    `;
  }
}

// 查看投稿详情
async function viewContribution(id) {
  const contribution = await db.collection('contributions').doc(id).get();
  if (!contribution.exists) return alert('投稿不存在或已被删除');
  
  const data = contribution.data();
  
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <h3 class="modal-title">${data.title}</h3>
      <div class="news-meta">
        <span><i class="fas fa-user"></i> ${data.name}</span>
        <span><i class="fas fa-phone"></i> ${data.contact}</span>
        <span><i class="fas fa-clock"></i> ${formatDate(data.submittedAt)}</span>
        <span class="category-tag">${data.category}</span>
      </div>
      
      <div class="news-content" style="max-height: 60vh; overflow-y: auto;">
        ${data.content}
      </div>
      
      ${data.images && data.images.length > 0 ? `
        <div class="divider"></div>
        <h4><i class="fas fa-images"></i> 投稿图片</h4>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
          ${data.images.map(img => `<img src="${img}" style="max-height: 150px; border-radius: 8px;">`).join('')}
        </div>
      ` : ''}
      
      <div class="action-buttons">
        <button class="btn btn-success" id="modalApproveBtn">
          <i class="fas fa-check"></i> 通过投稿
        </button>
        <button class="btn btn-danger" id="modalRejectBtn">
          <i class="fas fa-times"></i> 拒绝投稿
        </button>
        <button class="btn btn-outline" id="modalCloseBtn">
          <i class="fas fa-times"></i> 关闭
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  modal.style.display = 'flex';
  
  // 绑定按钮事件
  document.getElementById('modalApproveBtn').addEventListener('click', () => {
    processContribution(id, 'approved');
    modal.remove();
  });
  
  document.getElementById('modalRejectBtn').addEventListener('click', () => {
    processContribution(id, 'rejected');
    modal.remove();
  });
  
  document.getElementById('modalCloseBtn').addEventListener('click', () => {
    modal.remove();
  });
}

// 处理投稿(通过/拒绝)
async function processContribution(id, action) {
  const confirmMsg = action === 'approved' 
    ? '确定要通过此投稿吗？通过后将会发布为新闻。' 
    : '确定要拒绝此投稿吗？拒绝后投稿人将收到通知。';
  
  if (!confirm(confirmMsg)) return;
  
  try {
    await db.collection('contributions').doc(id).update({ status: action });
    
    if (action === 'approved') {
      // 如果通过，创建新闻
      const contribution = await db.collection('contributions').doc(id).get();
      const data = contribution.data();
      
      const newsItem = {
        title: data.title,
        content: data.content,
        category: data.category,
        editor: `投稿: ${data.name}`,
        time: new Date().toISOString(),
        status: 'published',
        images: data.images || []
      };
      
      await db.collection('news').add(newsItem);
      alert('投稿已通过并发布为新闻！');
    } else {
      alert('投稿已拒绝');
    }
    
    // 重新加载投稿列表
    await loadContributions(document.getElementById('contributionFilter').value);
    
  } catch (error) {
    console.error('处理投稿失败:', error);
    alert('处理投稿失败，请重试！');
  }
}

// 在初始化函数中添加投稿筛选器事件监听
document.getElementById('contributionFilter').addEventListener('change', function() {
  loadContributions(this.value);
});

    
    // 初始化数据库
    async function togglePinNews(id, isPinned) {
      try {
        await db.collection("news").doc(id).update({ pinned: isPinned });
        return true;
      } catch (error) {
        console.error("置顶操作失败:", error);
        return false;
      }
    }
    
    // 获取所有新闻（按时间倒序排列）
    async function getAllNews() {
      try {
        const snapshot = await db.collection("news")
          .where("status", "==", "published") // ✅ 只取已发布新闻
          .orderBy("status") // ✅ Firestore 索引需要这个顺序
          .orderBy("pinned", "desc")
          .orderBy("time", "desc")
          .get();
        
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error("获取新闻失败:", error);
        return [];
      }
    }
    
    // 添加新新闻
    async function addNews(newsItem) {
      await db.collection("news").add(newsItem);
    }
    
    // 更新新闻
    async function updateNews(newsItem) {
      await db.collection("news").doc(newsItem.id).update(newsItem);
    }
    
    // 删除新闻
    async function deleteNewsById(id) {
      await db.collection("news").doc(id).delete();
    }
    
    // 获取单条新闻
    async function getNewsById(id) {
      const doc = await db.collection("news").doc(id).get();
      return doc.exists ? { id: doc.id, ...doc.data() } : null;
    }
    
    // 按类别获取新闻
    async function getNewsByCategory(category) {
      try {
        let query = db.collection("news").orderBy("time", "desc");
        if (category !== "all") {
          query = query.where("category", "==", category);
        }
        const snapshot = await query.get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error("按类别获取新闻失败:", error);
        throw error; // 抛出错误以便上层处理
      }
    }
    
    // 按状态获取新闻（发布/草稿）
    async function getNewsByStatus(status) {
      let query = db.collection("news").orderBy("time", "desc");
      if (status !== "all") {
        query = query.where("status", "==", status);
      }
      const snapshot = await query.get();
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    // 主题切换
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      // 更新图标
      const themeIcon = document.querySelector('.theme-toggle i');
      themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    }

    // 显示管理员登录模态框
    function showAdminLogin() {
      adminModal.style.display = "flex";
      adminPassword.focus();
    }

    function generateNewsCard(n, isAdmin = false) {
  const publicUrl = `${window.location.origin}${window.location.pathname}?id=${n.id}`;
  
  return `
  <div class="card news-card ${n.pinned ? 'pinned-news' : ''}" data-id="${n.id}">
    <div class="news-meta">
      <span><i class="fas fa-calendar-alt"></i> ${formatDate(n.time)}</span>
      <span class="category-tag">${n.category}</span>
      ${n.pinned ? '<span class="badge pinned"><i class="fas fa-thumbtack"></i> 置顶</span>' : ''}
    </div>
    <h3>${n.title}</h3>
    <div class="news-excerpt">
      ${stripHtml(n.content).substring(0, 100)}...
    </div>
    <div class="news-footer" style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
      <button class="btn btn-outline read-more" data-id="${n.id}">
        <i class="fas fa-book-open"></i> 阅读更多
      </button>
      <div class="share-icons" style="display: flex; gap: 0.5rem;">
        <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(publicUrl)}" 
           target="_blank" title="分享到Facebook" style="color: #3b5998;">
          <i class="fab fa-facebook-f"></i>
        </a>
        <a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(publicUrl)}&text=${encodeURIComponent(n.title)}" 
           target="_blank" title="分享到Twitter" style="color: #1da1f2;">
          <i class="fab fa-twitter"></i>
        </a>
        <a href="https://www.threads.net/intent/post?text=${encodeURIComponent(n.title + '\n\n' + publicUrl)}" 
           target="_blank" title="分享到Threads" style="color: #000;">
          <i class="fab fa-instagram"></i>
        </a>
        <a href="https://api.whatsapp.com/send?text=${encodeURIComponent(n.title + ' - ' + publicUrl)}" 
           target="_blank" title="分享到WhatsApp" style="color: #25d366;">
          <i class="fab fa-whatsapp"></i>
        </a>
      </div>
    </div>
    ${isAdmin ? `
    <div class="action-buttons">
      <button class="btn btn-primary edit-news" data-id="${n.id}">
        <i class="fas fa-edit"></i> 编辑
      </button>
      <button class="btn btn-danger delete-news" data-id="${n.id}">
        <i class="fas fa-trash"></i> 删除
      </button>
      <button class="btn ${n.pinned ? 'btn-warning' : 'btn-secondary'} pin-news" data-id="${n.id}">
        <i class="fas fa-thumbtack"></i> ${n.pinned ? '取消置顶' : '置顶'}
      </button>
    </div>
    ` : ''}
  </div>
  `;
}

    // 隐藏管理员登录模态框
    function hideAdminModal() {
      adminModal.style.display = "none";
      adminPassword.value = "";
    }

    // 管理员登录验证
    function verifyAdmin() {
      const password = adminPassword.value;
      if (password === "Microcomputersociety") {
        loginAs("admin");
        hideAdminModal();
      } else {
        alert("⚠️ 密码错误，请重新输入！");
        adminPassword.value = "";
      }
    }

    // 用户登录系统
    async function loginAs(selectedRole) {
      console.log("Logging in as:", selectedRole); // 调试日志
      role = selectedRole;
      document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
      logoutBtn.classList.remove('hidden');
      
      if (role === 'admin') {
        document.getElementById('contributionManagement').classList.remove('hidden');
        loadContributions();
        document.getElementById('dashboard').classList.remove('hidden');
        console.log("Loading admin news..."); // 调试日志
        await loadNewsForAdmin();
      } else {
        const contributeBtn = document.createElement('button');
    contributeBtn.className = 'btn btn-primary';
    contributeBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 我要投稿';
    contributeBtn.style.marginLeft = 'auto';
    contributeBtn.style.marginRight = '1rem';
    contributeBtn.addEventListener('click', () => {
      document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
      document.getElementById('contributeSection').classList.remove('hidden');
    });
    
    document.querySelector('.header-content').appendChild(contributeBtn);
        document.getElementById('newsList').classList.remove('hidden');
        await loadNewsList();
      }
    }

    // 登出功能
    function logout() {
      role = "";
      document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
      document.getElementById('login').classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      titleInput.value = "";
      editor.innerHTML = "";
      editingId = null;
    }

    // 富文本编辑器功能
    function execCmd(cmd, value = null) {
      document.execCommand(cmd, false, value);
      editor.focus();
    }

    function formatDate(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function stripHtml(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }

    // 新闻发布/更新功能
    async function publishNews() {
      const title = titleInput.value.trim();
      const content = editor.innerHTML.trim();
      const category = categorySelect.value;
      
      if (!title) return alert("⚠️ 请输入新闻标题！");
      if (!content || content === "<p><br></p>") return alert("⚠️ 新闻内容不能为空！");
      
      try {
        const newsItem = {
          title,
          content,
          category,
          editor: "管理员",
          time: new Date().toISOString(),  // 改为ISO格式时间
          status: 'published'
        };
        
        if (editingId) {
          // 更新现有新闻
          await db.collection("news").doc(editingId).update(newsItem);
          editingId = null;
          publishBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 发布新闻';
        } else {
          // 新增新闻
          await db.collection("news").add(newsItem);
        }
        
        // 重置表单
        titleInput.value = "";
        editor.innerHTML = "";
        categorySelect.value = "科技新闻";
        
        // 重新加载新闻列表
        await loadNewsForAdmin();
        alert(editingId ? "✅ 新闻更新成功！" : "✅ 新闻发布成功！");
      } catch (error) {
        console.error("发布新闻失败:", error);
        alert("❌ 发布新闻失败，请重试！错误信息: " + error.message);
      }
    }

    // 保存为草稿
    async function saveAsDraft() {
      const title = titleInput.value.trim();
      const content = editor.innerHTML.trim();
      const category = categorySelect.value;
      
      if (!title && !content) return alert("⚠️ 请输入标题或内容！");

      try {
        const newsItem = {
          title: title || "无标题",
          content: content || "<p>无内容</p>",
          category,
          editor: "管理员",
          time: new Date().toISOString(),  // 改为ISO格式时间
          status: 'draft'
        };
        
        if (editingId) {
          // 更新现有草稿
          await db.collection("news").doc(editingId).update(newsItem);
          alert("📝 草稿更新成功！");
        } else {
          // 新增草稿
          await db.collection("news").add(newsItem);
          alert("📝 草稿保存成功！");
        }
        
        // 重新加载新闻列表
        await loadNewsForAdmin();
        
      } catch (error) {
        console.error("保存草稿失败:", error);
        alert("❌ 保存草稿失败，请重试！错误信息: " + error.message);
      }
    }

    // 新闻删除功能
    async function deleteNews(id) {
      if (!confirm("⚠️ 确定要永久删除这条新闻吗？")) return;
      
      try {
        await deleteNewsById(id);
        await loadNewsForAdmin();
        alert("🗑️ 新闻已删除！");
      } catch (error) {
        console.error("删除新闻失败:", error);
        alert("❌ 删除新闻失败，请重试！");
      }
    }

    // 新闻编辑功能
    async function editNews(id) {
      try {
        const newsItem = await getNewsById(id);
        titleInput.value = newsItem.title;
        editor.innerHTML = newsItem.content;
        categorySelect.value = newsItem.category || "科技新闻";
        editingId = id;
        
        // 更新按钮文本
        publishBtn.innerHTML = 
          newsItem.status === 'draft' ? 
          '<i class="fas fa-paper-plane"></i> 发布新闻' : 
          '<i class="fas fa-sync-alt"></i> 更新新闻';
        
        window.scrollTo({ top: 0, behavior: "smooth" });
      } catch (error) {
        console.error("加载新闻失败:", error);
        alert("❌ 加载新闻失败，请重试！");
      }
    }

    // 加载管理员界面
    // 管理员界面加载新闻
async function loadNewsForAdmin() {
  try {
    const filter = newsFilter.value;
    let news;

    if (filter === 'drafts') {
      news = await getNewsByStatus('draft');
    } else if (filter === 'published') {
      news = await getNewsByStatus('published');
    } else {
      // 修改这里：使用正确的查询方式获取所有新闻
      const snapshot = await db.collection("news").orderBy("time", "desc").get();
      news = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    const container = document.getElementById("newsListAdmin");

    if (!news || news.length === 0) {
      container.innerHTML = `
        <div class="card">
          <p style="text-align: center; color: var(--color-meta);">暂无新闻</p>
          <div style="text-align: center; margin-top: 1rem;">
            <button class="btn btn-outline" onclick="loadNewsForAdmin()">🔁 重新加载</button>
          </div>
        </div>`;
      return;
    }

    // 渲染每条新闻
    container.innerHTML = news.map(n => generateNewsCard(n, true)).join("");

    // 添加按钮监听器（编辑、删除、置顶）
    document.querySelectorAll('.edit-news').forEach(btn => {
      btn.addEventListener('click', () => {
        editNews(btn.dataset.id);
      });
    });

    document.querySelectorAll('.delete-news').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        if (confirm("⚠️ 确定要删除这条新闻吗？")) {
          await deleteNewsById(id);
          await loadNewsForAdmin(); // 重新加载
        }
      });
    });

    document.querySelectorAll('.pin-news').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const isPinned = btn.innerText.includes("取消");
        const success = await togglePinNews(id, !isPinned);
        if (success) await loadNewsForAdmin();
      });
    });

  } catch (error) {
    console.error("加载新闻列表失败:", error);
    document.getElementById("newsListAdmin").innerHTML = `
      <div class="card">
        <p style="text-align: center; color: var(--color-accent);">
          <i class="fas fa-exclamation-triangle"></i> 加载新闻失败，请刷新重试
        </p>
      </div>
    `;
  }
}

    
    // 加载新闻列表
    async function loadNewsList() {
      try {
        const category = categoryFilter.value;
        const news = await getNewsByCategory(category);
        
        // 按时间降序排序
        news.sort((a, b) => new Date(b.time) - new Date(a.time));
        const container = document.getElementById("newsItems");
        
        if (news.length === 0) {
          container.innerHTML = `
          <div class="card">
          <p style="text-align: center; color: var(--color-meta);">
            暂无新闻
            </p>
            </div>
            `;
          return;
        }
        
        container.innerHTML = news.map(n => `
        <div class="card news-card clickable" data-id="${n.id}">
        <div class="news-meta">
        <span><i class="fas fa-calendar-alt"></i> ${formatDate(n.time)}</span>
        <span class="category-tag">${n.category}</span>
        </div>
        <h3>${n.title}</h3>
        <div class="news-excerpt">
        ${stripHtml(n.content).substring(0, 100)}...
        </div>
        </div>
        `).join("");
        
        // 添加点击事件
        document.querySelectorAll('.news-card').forEach(card => {
          card.addEventListener('click', () => {
            showNewsDetail(card.dataset.id);
          });
        });
      } catch (error) {
        console.error("加载新闻列表失败:", error);
        document.getElementById("newsItems").innerHTML = `
        <div class="card">
        <p style="text-align: center; color: var(--color-accent);">
        <i class="fas fa-exclamation-triangle"></i> 加载新闻列表失败: ${error.message}
        </p>
        </div>
        `;
      }
    }
    // 显示新闻详情
    async function showNewsDetail(id) {
      try {
        const newsItem = await getNewsById(id);
        const detailContent = document.getElementById('detailContent');
    
    // 生成公开链接
        const publicUrl = `${window.location.origin}${window.location.pathname}?id=${id}`;
    
        detailContent.innerHTML = `
        <h1 class="news-title">${newsItem.title}</h1>
        <div class="news-meta">
        <span><i class="fas fa-calendar-alt"></i> ${formatDate(newsItem.time)}</span>
        <span><i class="fas fa-user-edit"></i> ${newsItem.editor}</span>
        <span class="category-tag">${newsItem.category}</span>
        </div>
        <div class="news-content">
        ${newsItem.content}
        </div>
        
        <div class="divider"></div>
        <div class="share-section">
        <h3><i class="fas fa-share-alt"></i> 分享这篇新闻</h3>
        <div class="share-buttons">
          <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(publicUrl)}" 
             target="_blank" class="share-btn facebook">
            <i class="fab fa-facebook-f"></i> Facebook
          </a>
          <a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(publicUrl)}&text=${encodeURIComponent(newsItem.title)}" 
             target="_blank" class="share-btn twitter">
            <i class="fab fa-twitter"></i> Twitter
          </a>
          <a href="https://www.threads.net/intent/post?text=${encodeURIComponent(newsItem.title + '\n\n' + publicUrl)}" 
             target="_blank" class="share-btn instagram">
            <i class="fab fa-instagram"></i> Threads
          </a>
          <a href="https://api.whatsapp.com/send?text=${encodeURIComponent(newsItem.title + ' - ' + publicUrl)}" 
             target="_blank" class="share-btn whatsapp">
            <i class="fab fa-whatsapp"></i> WhatsApp
          </a>
          <button class="share-btn link" id="copyLinkBtn">
            <i class="fas fa-link"></i> 复制链接
          </button>
        </div>
        </div>
        `;
    
    // 添加复制链接功能
        document.getElementById('copyLinkBtn').addEventListener('click', () => {
          navigator.clipboard.writeText(publicUrl).then(() => {
            alert('链接已复制到剪贴板！');
          }).catch(err => {
            console.error('复制失败:', err);
            alert('复制失败，请手动复制链接');
          });
        });
    
    // 显示详情部分
    document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
    document.getElementById('newsDetail').classList.remove('hidden');
  } catch (error) {
    console.error('加载新闻详情失败:', error);
    alert('加载新闻详情失败！');
  }
}
    // 返回新闻列表
    function showNewsList() {
      document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
      document.getElementById('newsList').classList.remove('hidden');
    }

    // 初始化页面
    async function initialize() {
      addFloatingButton();
      try {
        
        // 初始化主题
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        const themeIcon = document.querySelector('.theme-toggle i');
        themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';

        // 处理URL参数
        const params = new URLSearchParams(location.search);
        const id = params.get('id');
        
        if (id) {
          // 直接访问详情页
          document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
          document.getElementById('newsDetail').classList.remove('hidden');
          await showNewsDetail(id);
          role = 'guest';
          logoutBtn.classList.remove('hidden');
        } else {
          // 显示登录界面
          document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
          document.getElementById('login').classList.remove('hidden');
          logoutBtn.classList.add('hidden');
        }

        // 设置编辑器保护
        editor.addEventListener("blur", () => {
          if (editor.innerHTML.trim() === "") {
            editor.innerHTML = "<p><br></p>";
          }
        });
        
      } catch (error) {
        console.error("初始化失败:", error);
        document.getElementById('login').innerHTML = `
          <div class="card">
            <h2 style="text-align: center; margin-bottom: 1rem;">系统错误</h2>
            <p style="text-align: center; color: var(--color-accent);">
              <i class="fas fa-exclamation-triangle"></i> 系统初始化失败，请刷新重试
            </p>
            <button class="btn btn-primary full-width" onclick="location.reload()">
              <i class="fas fa-sync-alt"></i> 刷新页面
            </button>
          </div>
        `;
      }
    }

    function bindPinButtons() {
      document.querySelectorAll('.pin-news').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const isCurrentlyPinned = btn.classList.contains('btn-warning');
          
          const success = await togglePinNews(id, !isCurrentlyPinned);
          if (success) {
            await loadNewsForAdmin();
          } else {
            alert('置顶操作失败，请重试');
          }
        });
      });
    }

    function addFloatingButton() {
      const floatBtn = document.createElement('div');
      floatBtn.className = 'floating-action-btn hidden';
      floatBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
      floatBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
      document.body.appendChild(floatBtn);
      
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
          floatBtn.classList.remove('hidden');
        } else {
          floatBtn.classList.add('hidden');
        }
      });
    }
    
    // 绑定事件监听器
    function bindEventListeners() {
      // 主题切换
      themeToggle.addEventListener('click', toggleTheme);
      
      // 登录按钮
      adminLoginBtn.addEventListener('click', showAdminLogin);
      guestLoginBtn.addEventListener('click', () => loginAs('guest'));
      
      // 登出按钮
      logoutBtn.addEventListener('click', logout);
      
      // 模态框按钮
      confirmLoginBtn.addEventListener('click', verifyAdmin);
      cancelLoginBtn.addEventListener('click', hideAdminModal);
      
      // 新闻管理按钮
      newsFilter.addEventListener('change', () => loadNewsForAdmin());
      categoryFilter.addEventListener('change', () => loadNewsList());
      
      // 编辑器按钮
      draftBtn.addEventListener('click', saveAsDraft);
      publishBtn.addEventListener('click', publishNews);
      
      // 返回按钮
      backToListBtn.addEventListener('click', showNewsList);

      bindPinButtons();
      
      // 富文本工具按钮
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const title = btn.getAttribute('title');
          if (title === '加粗') execCmd('bold');
          else if (title === '斜体') execCmd('italic');
          else if (title === '下划线') execCmd('underline');
          else if (title === '无序列表') execCmd('insertUnorderedList');
          else if (title === '有序列表') execCmd('insertOrderedList');
          else if (title === '左对齐') execCmd('justifyLeft');
          else if (title === '居中对齐') execCmd('justifyCenter');
          else if (title === '右对齐') execCmd('justifyRight');
          else if (title === '插入图片') insertImage();
          else if (title === '插入链接') execCmd('createLink');
          else if (title === '移除链接') execCmd('unlink');
        });
      });

      // 删除按钮事件绑定
      document.querySelectorAll('.delete-news').forEach(btn => {
        btn.addEventListener('click', () => {
          deleteNews(btn.dataset.id);
        });
      });
      
      // 字体选择
      document.querySelector('.font-selector').addEventListener('change', function() {
        execCmd('fontName', false, this.value);
      });
      
      // 字号选择
      document.querySelector('.size-selector').addEventListener('change', function() {
        execCmd('fontSize', false, this.value);
      });
    }

    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', async () => {
      await initialize();
      bindEventListeners();
    });
  </script>
</body>
</html>
